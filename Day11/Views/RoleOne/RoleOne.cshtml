
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="~/Scripts/jquery-3.4.1.js"></script>
    <link href="~/Content/layui-v2.5.7/layui/css/layui.css" rel="stylesheet" />
    <script src="~/Content/layui-v2.5.7/layui/layui.js"></script>
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body>
    <div class="layui-btn-container">
        
    </div>
    <table>
        <tr>
            <td valign="top">
                <div id="test12" class="demo-tree-more"></div>
            </td>
            <td>
                <button type="button" class="layui-btn layui-btn-sm" lay-demo="getChecked">添加</button>
                当前角色:<span id="lblRoleName"></span> <input type="hidden" id="hdRoleId" value="0" />
                <div id="test13" class="demo-tree-more">
                </div>
            </td>
        </tr>
    </table>
    

    <script>
        layui.use(['tree', 'util'], function () {
            var tree = layui.tree
                , layer = layui.layer
                , util = layui.util

            //按钮事件
            util.event('lay-demo', {
                getChecked: function () {
                    var checkedData = tree.getChecked('demoId2'); //获取选中节点的数据
                    var menusIds = [];
                    menusIds = getCheckedId(checkedData);
                    var roleId = $("#hdRoleId").val();
                    alert(roleId);
                    alert(menusIds);
                    $.ajax({
                        url: '/RoleOne/AddRoleTwo',
                        type: 'get',
                        data: { roleId: roleId, menuIds: menusIds },
                        success:
                            function (d) {
                                if (d > 0) {
                                    layer.msg("保存成功");
                                }
                                else {
                                    layer.msg("保存失败");
                                }
                            }
                    })
                }

            });
            function getCheckedId(data) {
                var id = "";
                $.each(data, function (index, item) {
                    if (id != "") {
                        id = id + "," + item.id;
                    }
                    else {
                        id = item.id;
                    }
                    //item 没有children属性
                    if (item.children != null) {
                        var i = getCheckedId(item.children);
                        if (i != "") {
                            id = id + "," + i;
                        }
                    }
                });
                return id;
            }
            //基本演示
            tree.render({
                elem: '#test12'
                , data: GetRoleData()
                , id: 'demoId1'
                , isJump: true //是否允许点击节点时弹出新窗口跳转
                , click: function (obj) {
                    tree.reload('demoId2', {});
                    var data = obj.data;  //获取当前点击的节点数据
                    $("#lblRoleName").html(data.title);
                    $("#hdRoleId").val(data.id);
                    var menusId = GetMenusIds(data.id);
                    var ids = eval(menusId);
                    tree.setChecked('demoId2', ids);
                }
            });
            //基本演示
            tree.render({
                elem: '#test13'
                , data: GetMenusData()
                , showCheckbox: true  //是否显示复选框
                , id: 'demoId2'
                , isJump: true //是否允许点击节点时弹出新窗口跳转
                , click: function (obj) {
                    var data = obj.data;  //获取当前点击的节点数据
                    layer.msg('状态：' + obj.state + '<br>节点数据：' + JSON.stringify(data));
                }
            });

        });
        function GetRoleData() {
            var result = [];
            $.ajax({
                url: '/RoleOne/GetRole',
                type: 'get',
                dataType: 'json',
                async: false,
                success:
                    function (d) {
                        result = d;
                    }
            })
            return result;
        }
        function GetMenusData() {
            var result = [];
            $.ajax({
                url: '/RoleOne/GetMenus',
                type: 'get',
                dataType: 'json',
                async: false,
                success:
                    function (d) {
                        result = d;
                    }
            })
            return result;
        }

        function GetMenusIds(roleid) {
            var result = "";
            $.ajax({
                url: '/RoleOne/GetMenusIds',
                type: 'get',
                dataType: 'json',
                data: { roleId: roleid },
                async: false,
                success:
                    function (data) {
                        result = data;
                    }
            })
            return result;
        }
    </script>

</body>
</html>
